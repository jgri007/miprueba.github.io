<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-173632124-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-173632124-1');

    </script>
    <title>Obras España</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
        /* Always set the map height explicitly to define the size of the div
     * element that contains the map.
     */
        #map {
            height: 100%;
        }

        /* Optional: Makes the sample page fill the window. */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial;
        }

        /* We want to have a pointer cursor when hovering a deck.gl item */
        body.cursor-pointer .gm-style>div {
            cursor: pointer !important;
        }

        /* Style the legend */
        .legend {
            position: absolute;
            top: 0;
            background: rgba(255, 255, 255, .8);
            padding: 0.5em 1em;
            margin: 60px 10px;
            font-family: Arial;
            font-size: small;
            line-height: 1.5;
            border-radius: 10px;
            box-shadow: 2px 2px 2px 2px #888888;
        }


        #legend span {
            width: 1.3em;
            height: 1.3em;
            display: inline-block;
            vertical-align: top;
        }

        td {
            font-family: Arial;
            font-size: smaller;
        }


        /* tr:nth-child(even) {background-color: #f2f2f2;} */

    </style>
</head>

<body>

    <div id="map"></div>

    <div class="legend" style="left: 0;" id="info">
        <button type="button" onclick=oculta() id="oculta">X</button>
        <button type="button" onclick=dondeEstoy()>¿Dónde estoy?</button>
        <span style="color:darkslateblue; font-size:80%;"> Versión: 1.9 (2020-Septiembre) </span>
        <p id="resumen"></p>
        <a id="myLink" href="#" onclick="abreUrlConDatosMapaActual();">Obras Finalizadas</a>
    </div>

    <script>
        console.log("Hello World !");
        console.log(colorPorRango(150));

        const spain = {
            lat: 36.7,
            lng: -6.9
        };
        var centroMapa = spain;
        var zoomInicial = 6;

        leerParametrosUrl();

        function leerParametrosUrl() {
            console.log("Leo los parámetros de la URL");
            const queryString = window.location.search;
            console.log(queryString);
            const urlParams = new URLSearchParams(queryString);

            console.log(urlParams.has("product"));

            if (urlParams.has("lat")) {
                var lat = urlParams.get("lat");
                centroMapa.lat = parseFloat(lat);
            }

            if (urlParams.has("lng")) {
                var lng = urlParams.get("lng");
                centroMapa.lng = parseFloat(lng);
            }

            if (urlParams.has("zoom")) {
                var zoom = urlParams.get("zoom");
                zoomInicial = parseFloat(zoom);
            }

        }

        function abreUrlConDatosMapaActual() {
            var actLat = map.getCenter().lat().toFixed(4);
            var actLng = map.getCenter().lng().toFixed(4);
            var actZoom = map.getZoom();
            var parametrosUrl = "?lat=" + actLat + "&lng=" + actLng + "&zoom=" + actZoom;
            var miUrl = "ObrasFinalizadas.html" + parametrosUrl;
            window.open(miUrl, "_self");
        }

        document.getElementById("resumen").innerHTML = "Pulse el ratón por un marcador para identificar la obra";
        let map;
        const fuelColorMapping = {
            "Tramitación y planificación de Obra": [255, 255, 153, 194],
            "Cerramientos y acabados": [253, 191, 111, 194],
            "Redacción de proyecto": [51, 160, 44, 194],
            "Estructura": [227, 26, 28, 194],
            "Abandonada": [177, 89, 40, 194],
            "- Activa": [178, 223, 138, 194],
            "AAAA": [51, 160, 44, 194],
            "BBBB": [166, 206, 227, 194],
            "CCCC": [31, 120, 180, 194],
            "DDDD": [31, 120, 180, 194],
            "EEEE": [202, 178, 214, 194],
            "FFFF": [106, 61, 154, 194],
            "GGGG": [251, 154, 153, 194],
            "HHHH": [255, 127, 0, 194]
        };

        // Initialize the map
        function initMap() {
            var spain = {
                lat: 36.7,
                lng: -6.9
            };

            map = new google.maps.Map(document.getElementById("map"), {
                center: centroMapa,
                minZoom: 3,
                zoom: zoomInicial,
                clickableIcons: false,
                zoomControl: true,
                fullscreenControl: true,
                styles: [{ // Mapa oscuro.
                    "featureType": "all",
                    "elementType": "all",
                    "stylers": [{
                            "saturation": "-70"
                        },
                        {
                            "gamma": "1"
                        },
                        {
                            "visibility": "simplified"
                        },
                        {
                            "lightness": "-30"
                        }
                    ]
                }]
            });

            // dondeEstoy() ;	// Localizar la posición del navegador

        }

        // Create a deck.gl Google Maps overlay from spreadsheet data.
        // The data is passed directly from the JSONP callback.
        function createOverlay(spreadsheetData) {

            console.log(spreadsheetData);
            // Create GeoJSON from the spreadsheet data.
            const data = {
                type: "FeatureCollection",
                features: spreadsheetData.feed.entry.map(item => {

                    var estadoOportunidad = (item.gsx$estadooportunidad.$t);

                    //if (estadoOportunidad === "Ganada" || estadoOportunidad === "Perdida" ) {
                    if (estadoOportunidad != "Ganada" && estadoOportunidad != "Perdida") {
                        return obraMostrar(item);
                    } else {
                        return obraNoMostrar();
                    }

                })
            };

            function obraNoMostrar() {
                return {
                    type: "Feature",
                    geometry: {
                        type: "Point",
                        coordinates: [90, 0] // Los pongo en el Polo Norte para que no se vean
                    },
                    properties: {
                        nviviendas: 0 // Tengo que ponerle valor porque calcula el tamaño del círculo
                    }
                }
            }

            function obraMostrar(item) {
                return {
                    type: "Feature",
                    geometry: {
                        type: "Point",
                        coordinates: [
                            Number(item.gsx$longitude.$t),
                            Number(item.gsx$latitude.$t)
                        ]
                    },
                    properties: {
                        arquitectura: item.gsx$arquitectura.$t,
                        autorestado: item.gsx$autorestado.$t,
                        constructor: item.gsx$constructor.$t,
                        coordenadas: item.gsx$coordenadas.$t,
                        cp: item.gsx$cp.$t,
                        descripcion: item.gsx$descripcion.$t,
                        direccion: item.gsx$direccion.$t,
                        duracion: item.gsx$duracion.$t,
                        estado: item.gsx$estado.$t,
                        estadooportunidad: item.gsx$estadooportunidad.$t,
                        finprevisto: item.gsx$finprevisto.$t,
                        idobra: item.gsx$idobra.$t,
                        inicio: item.gsx$inicio.$t,
                        latitude: item.gsx$latitude.$t,
                        longitude: item.gsx$longitude.$t,
                        marcaganadora: item.gsx$marcaganadora.$t,
                        notaslocalizacion: item.gsx$notaslocalizacion.$t,
                        nviviendas: item.gsx$nviviendas.$t,
                        poblacion: item.gsx$poblacion.$t,
                        presupuesto: item.gsx$presupuesto.$t,
                        presupuestoporvivienda: item.gsx$presupuestoporvivienda.$t,
                        promotor: item.gsx$promotor.$t,
                        provincia: item.gsx$provincia.$t,
                        publicacion: item.gsx$publicacion.$t,
                        tipo: item.gsx$tipo.$t,
                        ultimavisita: item.gsx$ultimavisita.$t,
                        ultimanota: item.gsx$ultimanota.$t,
                        nota: item.gsx$nota.$t,
                        autornota: item.gsx$autornota.$t,
                    }
                }
            }

            // Create a GeoJsonLayer from the data and attach it to the map.
            const geojsonLayer = new GeoJsonLayer({
                id: "geojsonLayer",
                opacity: 0.95,
                data: data,
                pickable: true,
                pointRadiusUnits: ("meters"),
                pointRadiusMinPixels: 7,
                //pointRadiusMinPixels: d =>mapeaValor(map.getZoom(), 4, 22, 1, 30),
                pointRadiusMaxPixels: 120,
                pointRadiusScale: 1.0,
                //pointRadiusScale: 20 / Math.pow(map.getZoom(), 2),
                //lineWidthMaxPixels: 1000,
                lineWidthUnits: ("meters"),
                lineWidthScale: 1,
                lineWidthMinPixels: 2,
                getLineWidth: 3,
                getLineColor: [255, 0, 0, 90],
                wrapLongitude: true,
                // getRadius:  d => radioPorRango(d.properties.nviviendas),
                getRadius: d => d.properties.nviviendas * 1,
                getFillColor: d => colorPorRango(d.properties.nviviendas), // [Red, Green, Blue, Transparency]
                //getFillColor: d => fuelColorMapping[d.properties.marcaganadora] || [100, 100, 100, 194],
                autoHighlight: true,
            });

            const overlay = new GoogleMapsOverlay({
                layers: [geojsonLayer]
            });

            overlay.setMap(map);
            createInfowindow(overlay);

        }

        function mapeaValor(valor, fromLow, fromHigh, toLow, toHigh) {
            return (valor - fromLow) * (toHigh - toLow) / (fromHigh - fromLow) + toLow
        }

        function radioPorRango(oVal) {
            var radioMaximo = 500;


            if (oVal > 2000) {
                radio = radioMaximo;
            } else if (oVal > 150) {
                radio = radioMaximo * 0.5;
            } else if (oVal > 100) {
                radio = radioMaximo * 0.3;
            } else if (oVal > 50) {
                radio = radioMaximo * 0.2;
            } else if (oVal > 25) {
                radio = radioMaximo * 0.1;
            } else if (oVal > 10) {
                radio = radioMaximo * 0.05;
            } else if (oVal > 5) {
                radio = radioMaximo * 0.03;
            } else {
                radio = radioMaximo * 0.01;
            }

            return radio;

        }

        function colorPorRango(oVal) {
            var colorRGB = new Array(4);
            var trp = 180; // Transparencia (0 - 255)

            if (oVal > 200) {
                colorRGB = [255, 0, 0, trp];
            } else if (oVal > 150) {
                colorRGB = [255, 128, 0, trp];
            } else if (oVal > 100) {
                colorRGB = [255, 255, 0, trp];
            } else if (oVal > 50) {
                colorRGB = [191, 0, 255, trp];
            } else if (oVal > 25) {
                colorRGB = [0, 64, 255, trp];
            } else if (oVal > 10) {
                colorRGB = [0, 255, 255, trp];
            } else if (oVal > 5) {
                colorRGB = [0, 255, 255, trp];
            } else {
                colorRGB = [210, 180, 222, trp];
            }

            return colorRGB;

        }

        function colorPorValor(oVal) {
            var oMin = 10; // Valor mínimo para la escala de colores del número de viviendas
            var oMax = 255; // Valor máximo para la escala de colores del número de viviendas

            if (oVal < oMin) {
                oVal = oMin;
            };
            if (oVal > oMax) {
                oVal = oMax;
            };


            // delta represents where the value sits between the min and max
            var delta = 255 * (oVal - oMin) / (oMax - oMin);


            var colorRGB = new Array(4);
            colorRGB[0] = parseInt(delta);
            colorRGB[1] = parseInt(255 - delta);
            colorRGB[2] = 0;
            colorRGB[3] = 190;

            // alert("Número: " + oVal + " Mínimo: " + oMin + " Máximo: " + oMax + " Delta: " + delta + " Color: " + colorRGB);

            return {
                colorValor: colorRGB
            };
            // return {colorValor: [31, 120, 180, 190]};
        }

        // Create an infowindow and listen for clicks on the deck.gl Layer
        function createInfowindow(overlay) {
            const infowindow = new google.maps.InfoWindow({
                content: ""
            });

            // Change the cursor to a pointer on mouseover
            map.addListener("mousemove", event => {


                const picked = overlay._deck.pickObject({
                    x: event.pixel.x,
                    y: event.pixel.y,
                    radius: 4,
                    layerIds: ["geojsonLayer"]
                });
                document.body.classList.toggle("cursor-pointer", picked);
                document.getElementById("resumen").innerHTML =
                    "<b>" + picked.object.properties.idobra +
                    " - " + picked.object.properties.descripcion + "</b> " +
                    " " + picked.object.properties.nviviendas + " Viviendas" +
                    "<b><br>Estado: </b>" + picked.object.properties.estado +
                    " (" + picked.object.properties.ultimavisita +
                    " - " + picked.object.properties.autorestado + ")" +
                    "<b><br>Nota: </b>" + picked.object.properties.nota +
                    " (" + picked.object.properties.ultimanota +
                    " - " + picked.object.properties.autornota + ")";
                infowindow.close();
            });


            map.addListener("click", event => {

                // alert("Zoom Mapa: " + map.getZoom() + " Radio Mínimo: " + mapeaValor(map.getZoom(), 6, 22, 4, 80));

                const picked = overlay._deck.pickObject({
                    x: event.pixel.x,
                    y: event.pixel.y,
                    radius: 4,
                    layerIds: ["geojsonLayer"]
                });

                var sIdObra = picked.object.properties.idobra;

                infowindow.setContent(
                    `<div>		   
			<font face="Calibri"> 
			<table style="width:100%"> 
              <tr><th colspan="6"><h2>  ${picked.object.properties.descripcion} </h2></th></tr> 
              <tr> <th colspan="6"><hr></th> </tr> 
              <tr><td><b>N. Viviendas:</b></td> <td>  ${picked.object.properties.nviviendas}  </td> 
                <td><b>Publicacion:</b></td> <td>  ${picked.object.properties.publicacion}  </td> 
                <td><b>Id:</b></td> <td>  ${sIdObra}  </td></tr> 
              <tr> <th colspan="6"><hr></th> </tr> 
              <tr><td><b>Direccion:</b></td> <td colspan="5">  ${picked.object.properties.direccion} ${picked.object.properties.cp} - ${picked.object.properties.poblacion} (${picked.object.properties.provincia})</td></tr> 
              <td><b>Localizacion:</b></td> <td colspan="3">  <a href="https://google.com/maps/place/ ${picked.object.properties.latitude}  ,  ${picked.object.properties.longitude} "target="_blank"> ${picked.object.properties.latitude}  ,  ${picked.object.properties.longitude}  (  ${picked.object.properties.notaslocalizacion}  )</td></tr> 
              <td><b>Registro visita:</b></td> <td colspan="3">  <a href="https://docs.google.com/forms/d/e/1FAIpQLSeiHKFBuupwUNDenTAU43OynJFFKuZ_fQyJwUIAW3G0YcYuNw/viewform?usp=pp_url&entry.761727091= ${sIdObra} "target="_blank"> Formulario registro obra ( ${sIdObra}   )</a></td></tr> 
              <tr> <th colspan="6"><hr></th> </tr> 
              <tr> <td><b>Promotor:</b></td> <td colspan="5">  ${picked.object.properties.promotor}  </td></tr> 
              <tr> <td><b>Arquitectura:</b></td> <td colspan="5">  ${picked.object.properties.arquitectura}  </td></tr> 
              <tr> <td><b>Constructor:</b></td> <td colspan="5">  ${picked.object.properties.constructor}  </td></tr> 
              <tr> <th colspan="6"><hr></th> </tr> 
              <tr> <td><b>Presupuesto:</b></td> <td>  ${picked.object.properties.presupuesto}  </td> 
                <td><b>Por vivienda:</b></td> <td>  ${picked.object.properties.presupuestoporvivienda}  </td></tr> 
              <tr> <th colspan="6"><hr></th> </tr> 
              <tr> <td><b>Tipo obra:</b></td> <td>  ${picked.object.properties.tipo}  </td> 
                <td><b>Fecha inicio:</b></td> <td>  ${picked.object.properties.inicio}  </td></tr> 
              <tr> <td><b>Duracion:</b></td> <td>  ${picked.object.properties.duracion}   meses</td> 
                <td><b>Fecha fin prevista:</b></td> <td>  ${picked.object.properties.fin}  </td></tr> 
              <tr> <th colspan="6"><hr></th> </tr> 
              <tr> <td><b>Oportunidad:</b></td> <td>  ${picked.object.properties.estadooportunidad}  </td> 
                <td><b>Marca ganadora:</b></td> <td>  ${picked.object.properties.marcaganadora}  </td></tr> 
              <tr> <td><b>Estado:</b></td> <td colspan="5"> ${picked.object.properties.estado} (${picked.object.properties.ultimavisita} - ${picked.object.properties.autorestado})  </td></tr> 
              <tr> <td><b>Nota:</b></td> <td colspan="5"> ${picked.object.properties.nota} (${picked.object.properties.ultimanota} - ${picked.object.properties.autornota})  </td></tr>
              <tr> <th colspan="6"><hr></th> </tr> 
            </table> 
		  </div>`
                );



                infowindow.setPosition({
                    lng: picked.lngLat[0],
                    lat: picked.lngLat[1]
                });
                infowindow.open(map);
            });
        }


        // Render a legend to show what the colors mean
        function createLegend() {
            document.getElementById("legend").innerHTML +=
                Object.keys(fuelColorMapping).map(fuel => `<div>
            <span style="background: rgba(${fuelColorMapping[fuel]})"></span>
            ${fuel}
          </div>`).join("");
        }

        function dondeEstoy() {
            // Localiza la posición del navegador y hace un zoom cercano a la zona
            infoWindow = new google.maps.InfoWindow;
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    document.getElementById("resumen").innerHTML =
                        "Localizacion encontrada. Coordenadas: " +
                        position.coords.latitude.toFixed(4) + " , " + position.coords.longitude.toFixed(4);

                    map.setCenter(pos);
                    map.setZoom(20);
                }, function() {
                    handleLocationError(true, infoWindow, map.getCenter());
                });
            } else {
                // Browser doesn"t support Geolocation
                handleLocationError(false, infoWindow, map.getCenter());
            }
        }

        function oculta() {

            var x = document.getElementById("info");
            if (x.style.display === "none") {
                x.style.display = "block";
                document.getElementById("oculta").innerHTML = "X";
            } else {
                x.style.display = "none";
                document.getElementById("oculta").innerHTML = "O";
            }
        }

    </script>

    <!--
    To use this in your own project you need to have your own Google Maps Api key.
    https://developers.google.com/maps/documentation/javascript/get-api-key
  -->

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCoDR7MIPA4VywExVkh7c3wmK3HLSChyMw&region=ES&callback=initMap"></script>
    <!--
    deck.gl is needed to render the data onto the Google Map
  -->
    <script src="https://unpkg.com/deck.gl@7.0.9/dist.min.js"></script>

    <!--
    This is the spreadsheet that was used for this example:
    https://docs.google.com/spreadsheets/d/1MsFYOQlys_jyTACIZRbk3VWX9qaUdfrsr_r2Y-oxuZo
    To be able to pull data from a spreadsheet, it needs to be
    "Published to the web". In the spreadsheet go to
    "File" -> "Publish to the web" -> Click the publish button
    The only thing you need to swap out in the script tag below is
    the spreadsheet id .../list/YOUR_SPREADSHEET_ID/1/...
  -->
    <script src="https://spreadsheets.google.com/feeds/list/1uQAQE42Am4pKam9sGE42-UgXdIe17r8Mg9Dms-ScCu8/1/public/values?alt=json-in-script&callback=createOverlay">
        // Este es solo Valencia (Para Pruebas y rapidez)
        // src="https://spreadsheets.google.com/feeds/list/1b_wQmJxyWgiHek9qJPwJK86PoTe4bEvMnx1Rk0RzhKM/1/public/values?alt=json-in-script&callback=createOverlay">


        // Este es el de toda España
        // src="https://spreadsheets.google.com/feeds/list/1uQAQE42Am4pKam9sGE42-UgXdIe17r8Mg9Dms-ScCu8/1/public/values?alt=json-in-script&callback=createOverlay">

    </script>

</body>

</html>
