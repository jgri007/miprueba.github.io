<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-173632124-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-173632124-1');
</script>
  <title>Obras Finalizadas España</title>
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
  <style>
    /* Always set the map height explicitly to define the size of the div
     * element that contains the map.
     */
    #map {
      height: 100%;
    }

    /* Optional: Makes the sample page fill the window. */
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial;
    }

    /* We want to have a pointer cursor when hovering a deck.gl item */
    body.cursor-pointer .gm-style>div {
      cursor: pointer !important;
    }

    /* Style the legend */
    .legend {
      position: absolute;
      top: 0;
      background: rgba(255, 255, 255, .8);
      padding: 0.5em 1em;
      margin: 60px 10px;
	  font-family: Arial; 
	  font-size: small;
	  line-height: 1.5;
      border-radius: 10px;
      box-shadow: 2px 2px 2px 2px #888888 ;
    }


    #legend span {
      width: 1.3em;
      height: 1.3em;
      display: inline-block;
      vertical-align: top;
    }

    td { 
	  font-family: Arial; 
	  font-size: small;
    }
    
    /* tr:nth-child(even) {background-color: #f2f2f2;} */
  </style>
</head>

<body>

  <div id="map"></div>
  
  <div class="legend" style="left: 0;" id="info">
    <button type="button" onclick=oculta() id="oculta">X</button>
    <button type="button" onclick=dondeEstoy()>¿Dónde estoy?</button> 
    <span style="color:darkslategrey; font-size:80%;"> Versión: 1.8 (2020-Julio) </span>
    <p id="resumen"></p>
    <a id='myLink' href='#' onclick='abreUrlConDatosMapaActual();'>Obras Activas</a>
  </div>
  
  <div class="legend" style="right: 0;" id="legend">

  </div>
  <script>
    console.log("Hello World !");
    
    const spain = {lat: 36.7, lng: -6.9};
    var centroMapa = spain;
    var zoomInicial = 6;
    
    leerParametrosUrl();
    
    function leerParametrosUrl(){
      console.log("Leo los parámetros de la URL");
      const queryString = window.location.search;
      console.log(queryString);
      const urlParams = new URLSearchParams(queryString);
      
      console.log(urlParams.has('product'));
      
      if (urlParams.has('lat')){
        var lat = urlParams.get('lat');
        centroMapa.lat = parseFloat(lat);
      }
      
      if (urlParams.has('lng')){
        var lng = urlParams.get('lng');
        centroMapa.lng = parseFloat(lng);
      }

      if (urlParams.has('zoom')){
        var zoom = urlParams.get('zoom');
        zoomInicial = parseFloat(zoom);
      }

    }
    
    function abreUrlConDatosMapaActual(){
      var actLat = map.getCenter().lat().toFixed(4);
      var actLng = map.getCenter().lng().toFixed(4);
      var actZoom = map.getZoom();
      var parametrosUrl = '?lat=' + actLat + '&lng=' + actLng + '&zoom=' + actZoom;
      var miUrl = 'index.html' + parametrosUrl;
      window.open(miUrl,'_self');
    }
     
    document.getElementById('resumen').innerHTML = 'Pulse el ratón por un marcador para identificar la obra' ;
    let map;
    let trp = 180 ; // Transparencia
    const mapeadoColorMarca = {      
      'Fermax': [31, 97, 141, trp],
      'Comelit': [30, 132, 73, trp],
      'Golmar': [185, 119, 14, trp],
      'ABB': [209, 0, 16, trp],
      'Tegui': [47, 0, 132, trp],
      'Auta': [254, 220, 61, trp],
      'Zennio': [0, 0, 147, trp],
      'Otro': [255, 127, 0, trp]
    };
    
    
    function createLegend() {
      console.log ("Legend----")
      document.getElementById('legend').innerHTML +=
        Object.keys(mapeadoColorMarca).map(marcaganadora => `<div>
            <span style="background: rgba(${mapeadoColorMarca[marcaganadora]})"></span>
            ${marcaganadora}
          </div>`
        ).join('');
    }
    
    const mapeadoEstiloOportunidad = {      
      'Ganada':  '<span style="color:white; background-color:DarkGreen;"> Ganada </span>',
      'Perdida': '<span style="color:white; background-color:DarkRed;"> Perdida </span>'
    };
    
    // Initialize the map
    function initMap() {
      console.log(centroMapa);
      map = new google.maps.Map(document.getElementById('map'), {
        center: centroMapa,
        minZoom: 3,
        zoom: zoomInicial,
        clickableIcons: false,
        zoomControl: true,
        fullscreenControl: true,
        styles: [{    // Mapa oscuro.
          "featureType": "all",
          "elementType": "all",
          "stylers": [
            {"saturation": "-95"},
            {"gamma": "1"},
            {"visibility": "simplified"},
            {"lightness": "-20"}
          ]
        }]
      });
    }

    // Create a deck.gl Google Maps overlay from spreadsheet data.
    // The data is passed directly from the JSONP callback.
    function createOverlay(spreadsheetData) {
      
      console.log(spreadsheetData);
      // Create GeoJSON from the spreadsheet data.
      const data = {
        type: 'FeatureCollection',
        features: spreadsheetData.feed.entry.map(item => {
          
        var estadoOportunidad = (item.gsx$estadooportunidad.$t);
        
        if (estadoOportunidad === "Ganada" || estadoOportunidad === "Perdida" ) {
        // if (estadoOportunidad != "Ganada" && estadoOportunidad != "Perdida" ) {
          return obraMostrar(item); 
        } else {
          return obraNoMostrar();        
        }
          
        }) 
      };
      
      function obraNoMostrar(){
        return {
          type: 'Feature',
          geometry: {
            type: 'Point',
            coordinates: [0,90] // Los pongo en el Polo Norte para que no se vean
          },
          properties: {
		    nviviendas: 0   // Tengo que ponerle valor porque calcula el tamaño del círculo
          }
        }
      }
      
      function obraMostrar(item){
        return {
          type: 'Feature',
          geometry: {
            type: 'Point',
            coordinates: [
              Number(item.gsx$longitude.$t),
              Number(item.gsx$latitude.$t)
            ]
          },
          properties: {
            arquitectura: item.gsx$arquitectura.$t,
		    autorestado: item.gsx$autorestado.$t,
		    constructor: item.gsx$constructor.$t,
		    coordenadas: item.gsx$coordenadas.$t,
		    cp: item.gsx$cp.$t,
		    descripcion: item.gsx$descripcion.$t,
		    direccion: item.gsx$direccion.$t,
		    duracion: item.gsx$duracion.$t,
		    estado: item.gsx$estado.$t,
		    estadooportunidad: item.gsx$estadooportunidad.$t,
		    finprevisto: item.gsx$finprevisto.$t,
		    idobra: item.gsx$idobra.$t,
		    inicio: item.gsx$inicio.$t,
		    latitude: item.gsx$latitude.$t,
		    longitude: item.gsx$longitude.$t,
		    marcaganadora: item.gsx$marcaganadora.$t,
		    notaslocalizacion: item.gsx$notaslocalizacion.$t,
		    nviviendas: item.gsx$nviviendas.$t,
		    poblacion: item.gsx$poblacion.$t,
		    presupuesto: item.gsx$presupuesto.$t,
		    presupuestoporvivienda: item.gsx$presupuestoporvivienda.$t,
		    promotor: item.gsx$promotor.$t,
		    provincia: item.gsx$provincia.$t,
		    publicacion: item.gsx$publicacion.$t,
		    tipo: item.gsx$tipo.$t,
		    ultimavisita: item.gsx$ultimavisita.$t,
            ultimanota: item.gsx$ultimanota.$t,
            nota: item.gsx$nota.$t,
		    autornota: item.gsx$autornota.$t,
          }
        }
      }
      
      // Create a GeoJsonLayer from the data and attach it to the map.
      const geojsonLayer = new GeoJsonLayer({
        id: 'geojsonLayer',
        opacity: 0.8 ,
        data: data,
        pickable: true,
        pointRadiusMinPixels: 10,
        pointRadiusMaxPixels: 150,
        pointRadiusScale: 20,
        //lineWidthMaxPixels: 1000,
        lineWidthUnits: ('pixels'),
        lineWidthScale: 1,
        lineWidthMinPixels: 2,
        getLineWidth: 1,
        getLineColor: [100, 100, 100, 90],
        wrapLongitude: true,
        getRadius: d => d.properties.nviviendas * 0.1 ,
        getFillColor: d => mapeadoColorMarca[d.properties.marcaganadora] || mapeadoColorMarca["Otro"],  // [Red, Green, Blue, Transparency]
        autoHighlight: true,
      });
             
      const overlay = new GoogleMapsOverlay({
        layers: [geojsonLayer]
      });
      
      overlay.setMap(map);
      createInfowindow(overlay);
      createLegend();

    }
    
    // Create an infowindow and listen for clicks on the deck.gl Layer
    function createInfowindow(overlay) {
      var obra;
      const infowindow = new google.maps.InfoWindow({
        content: ''
      });
     
      // Change the cursor to a pointer on mouseover
      map.addListener('mousemove', event => {

        const picked = overlay._deck.pickObject({
          x: event.pixel.x,
          y: event.pixel.y,
          radius: 4,
          layerIds: ['geojsonLayer']
        });
        document.body.classList.toggle('cursor-pointer', picked);
        
        obra = picked.object.properties;
        //console.log("Obra: " + obra.idobra);
        
        if (obra.estadooportunidad === "Ganada"){
          document.getElementById('info').style.backgroundColor = "LightGreen";
        } else {
          document.getElementById('info').style.backgroundColor = "LightPink";
        }
        
        document.getElementById('resumen').innerHTML = 
          '<b>' + obra.idobra + '</b>'
              + '<br>' + obra.descripcion
              + '<br>' + obra.nviviendas + ' Viviendas' 
              + '<br>' + mapeadoEstiloOportunidad[obra.estadooportunidad]
              + '<br> Marca ganadora:  ' + obra.marcaganadora ;
          infowindow.close();
      });
      

      map.addListener('click', event => {
        const picked = overlay._deck.pickObject({
          x: event.pixel.x,
          y: event.pixel.y,
          radius: 4,
          layerIds: ['geojsonLayer']
        });
      
		var sIdObra = obra.idobra;
        
		infowindow.setContent(		  
		   `<div>		   
			<font face="Calibri"> 
			<table style="width:100%"> 
              <tr><th colspan="6"><h2>  ${obra.descripcion} </h2></th></tr> 
              <tr> <th colspan="6"><hr></th> </tr> 
              <tr><td><b>N. Viviendas:</b></td> <td>  ${obra.nviviendas}  </td> 
                <td><b>Publicacion:</b></td> <td>  ${obra.publicacion}  </td> 
                <td><b>Id:</b></td> <td>  ${sIdObra}  </td></tr> 
              <tr> <th colspan="6"><hr></th> </tr> 
              <tr><td><b>Direccion:</b></td> <td colspan="5">  ${obra.direccion} ${obra.cp} - ${obra.poblacion} (${obra.provincia})</td></tr> 
              <td><b>Localizacion:</b></td> <td colspan="3">  <a href="https://google.com/maps/place/ ${obra.latitude}  ,  ${obra.longitude} "target="_blank"> ${obra.latitude}  ,  ${obra.longitude}  (  ${obra.notaslocalizacion}  )</td></tr> 
              <td><b>Registro visita:</b></td> <td colspan="3">  <a href="https://docs.google.com/forms/d/e/1FAIpQLSeiHKFBuupwUNDenTAU43OynJFFKuZ_fQyJwUIAW3G0YcYuNw/viewform?usp=pp_url&entry.761727091= ${sIdObra} "target="_blank"> Formulario registro obra ( ${sIdObra}   )</a></td></tr> 
              <tr> <th colspan="6"><hr></th> </tr> 
              <tr> <td><b>Promotor:</b></td> <td colspan="5">  ${obra.promotor}  </td></tr> 
              <tr> <td><b>Arquitectura:</b></td> <td colspan="5">  ${obra.arquitectura}  </td></tr> 
              <tr> <td><b>Constructor:</b></td> <td colspan="5">  ${obra.constructor}  </td></tr> 
              <tr> <th colspan="6"><hr></th> </tr> 
              <tr> <td><b>Presupuesto:</b></td> <td>  ${obra.presupuesto}  </td> 
                <td><b>Por vivienda:</b></td> <td>  ${obra.presupuestoporvivienda}  </td></tr> 
              <tr> <th colspan="6"><hr></th> </tr> 
              <tr> <td><b>Tipo obra:</b></td> <td>  ${obra.tipo}  </td> 
                <td><b>Fecha inicio:</b></td> <td>  ${obra.inicio}  </td></tr> 
              <tr> <td><b>Duracion:</b></td> <td>  ${obra.duracion}   meses</td> 
                <td><b>Fecha fin prevista:</b></td> <td>  ${obra.fin}  </td></tr> 
              <tr> <th colspan="6"><hr></th> </tr> 
              <tr> <td><b>Oportunidad:</b></td> <td>  ${mapeadoEstiloOportunidad[obra.estadooportunidad]}  </td> 
                <td><b>Marca ganadora:</b></td> <td>  ${obra.marcaganadora}  </td></tr> 
              <tr> <td><b>Estado:</b></td> <td colspan="5"> ${obra.estado} (${obra.ultimavisita} - ${obra.autorestado})  </td></tr> 
              <tr> <td><b>Nota:</b></td> <td colspan="5"> ${obra.nota} (${obra.ultimanota} - ${obra.autornota})  </td></tr>
              <tr> <th colspan="6"><hr></th> </tr> 
            </table> 
		  </div>`		  
        );
		
        
        
        infowindow.setPosition({
          lng: picked.lngLat[0],
          lat: picked.lngLat[1]
        });
        infowindow.open(map);
      });
    }

	function dondeEstoy() {
	  // Localiza la posición del navegador y hace un zoom cercano a la zona
       infoWindow = new google.maps.InfoWindow;
       if (navigator.geolocation) {
         navigator.geolocation.getCurrentPosition(function(position) {
           var pos = {
             lat: position.coords.latitude,
             lng: position.coords.longitude
           };
           document.getElementById('resumen').innerHTML = 
             'Localizacion encontrada. Coordenadas: ' 
             + position.coords.latitude.toFixed(4) + ' , ' + position.coords.longitude.toFixed(4) ;
   
           map.setCenter(pos);
           map.setZoom (20);
         }, function() {
           handleLocationError(true, infoWindow, map.getCenter());
         });
       } else {
         // Browser doesn't support Geolocation
         handleLocationError(false, infoWindow, map.getCenter());
       }
	}
    
    function oculta() {
        document.getElementById('legend').style.display = 'none';
        document.getElementById('info').style.display = 'none';
    }
 
  </script>

  <!--
    To use this in your own project you need to have your own Google Maps Api key.
    https://developers.google.com/maps/documentation/javascript/get-api-key
  -->
   
  <script src='https://maps.googleapis.com/maps/api/js?key=AIzaSyCoDR7MIPA4VywExVkh7c3wmK3HLSChyMw&region=ES&callback=initMap'></script>
  <!--
    deck.gl is needed to render the data onto the Google Map
  -->
  <script src="https://unpkg.com/deck.gl@7.0.9/dist.min.js"></script>

  <!--
    This is the spreadsheet that was used for this example:
    https://docs.google.com/spreadsheets/d/1MsFYOQlys_jyTACIZRbk3VWX9qaUdfrsr_r2Y-oxuZo
    To be able to pull data from a spreadsheet, it needs to be
    "Published to the web". In the spreadsheet go to
    "File" -> "Publish to the web" -> Click the publish button
    The only thing you need to swap out in the script tag below is
    the spreadsheet id .../list/YOUR_SPREADSHEET_ID/1/...
  -->
  <script 
  src="https://spreadsheets.google.com/feeds/list/1uQAQE42Am4pKam9sGE42-UgXdIe17r8Mg9Dms-ScCu8/1/public/values?alt=json-in-script&callback=createOverlay">

    
  </script>

</body>

</html>
